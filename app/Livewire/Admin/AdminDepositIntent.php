<?php

namespace App\Livewire\Admin;

use App\Models\Deposit;
use App\Models\DepositIntent;
use App\Models\Referral;
use App\Models\User;
use App\Notifications\CommissionEarned;
use App\Notifications\DepositApproved;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Livewire\Attributes\Layout;
use Livewire\Component;
use Livewire\WithPagination;

#[Layout('components.layouts.admin')]

class AdminDepositIntent extends Component
{
  use WithPagination;

  public $firstUpline;

  public $secondUpline;

  public $thirdUpline;

  public array $allowReferral = [];

  public int $level = 0;

  public function getStatusIndicatorColor(string $status)
  {
    if ($status === "pending") {
      return "bg-warning-50 text-warning-600";
    }

    if ($status === "confirmed") {
      return "bg-success-50 text-success-600";
    }

    if ($status === "declined") {
      return "bg-error-50 text-error-600";
    }
  }

  public function computeUpline(string $referredBy)
  {
    // Reset properties
    $this->firstUpline = null;
    $this->secondUpline = null;
    $this->thirdUpline = null;
    $this->level = 0;

    $currentUpline = User::where(
      "referral_code",
      "=",
      $referredBy,
      "and",
    )->first();
    if ($currentUpline !== null) {
      $this->firstUpline = $currentUpline;
      $this->level = 1;
      Log::info("First upline found: " . $this->firstUpline["id"]);
      Log::info("Level: " . $this->level);
      $currentUpline = User::where(
        "referral_code",
        "=",
        $currentUpline["referred_by"],
        "and",
      )->first();
      if ($currentUpline !== null) {
        $this->secondUpline = $this->firstUpline;
        $this->firstUpline = $currentUpline;
        $this->level = 2;
        Log::info("Second upline found: " . $this->firstUpline["id"]);
        Log::info("Level: " . $this->level);
        $currentUpline = User::where(
          "referral_code",
          "=",
          $currentUpline["referred_by"],
          "and",
        )->first();
        if ($currentUpline !== null) {
          $this->thirdUpline = $this->secondUpline;
          $this->secondUpline = $this->firstUpline;
          $this->firstUpline = $currentUpline;
          $this->level = 3;
          Log::info("Third upline found: " . $this->firstUpline["id"]);
          Log::info("Level: " . $this->level);
        }
      }
    }
  }

  public function processReferralPayouts(
    float $depositAmount,
    string $referralCode,
    string $depositOwnerName,
  ) {
    if ($this->level === 1) {
      // Lock and fetch the first upline user
      $firstUpline = User::where("id", "=", $this->firstUpline["id"], "and")
        ->lockForUpdate()
        ->first();

      if (!$firstUpline) {
        throw new \Exception("First upline user not found");
      }

      /**
       * Top upline commission
       */
      $commission = intval(round($depositAmount * (8 / 100)));
      $newFirstUplineBalance = $firstUpline->live_balance + $commission;

      $firstUpline->live_balance = $newFirstUplineBalance;
      $firstUpline->save();

      Referral::create([
        "user_id" => $firstUpline->id,
        "referral_code" => $referralCode,
        "amount" => $commission,
        "level" => "1",
      ]);

      $firstUpline->notify(
        new CommissionEarned(
          $firstUpline->name,
          $depositOwnerName,
          strval($commission / 100),
          "deposit",
        ),
      );

      Log::info("Ran level 1 referral payout for user ID: " . $firstUpline->id);
    }

    if ($this->level === 2) {
      // Lock both upline users to prevent race conditions
      $secondUpline = User::where("id", "=", $this->secondUpline["id"], "and")
        ->lockForUpdate()
        ->first();

      if (!$secondUpline) {
        throw new \Exception("Second upline user not found");
      }

      $firstUpline = User::where("id", "=", $this->firstUpline["id"], "and")
        ->lockForUpdate()
        ->first();

      if (!$firstUpline) {
        throw new \Exception("First upline user not found");
      }

      /**
       * Middle upline commission
       */
      $commission = intval(round($depositAmount * (8 / 100)));
      $newSecondUplineBalance = $secondUpline->live_balance + $commission;

      $secondUpline->live_balance = $newSecondUplineBalance;
      $secondUpline->save();

      Referral::create([
        "user_id" => $secondUpline->id,
        "referral_code" => $referralCode,
        "amount" => $commission,
        "level" => "1",
      ]);

      $secondUpline->notify(
        new CommissionEarned(
          $secondUpline->name,
          $depositOwnerName,
          strval($commission / 100),
          "deposit",
        ),
      );

      /**
       * First upline commission
       */
      $commission = intval(round($depositAmount * (4 / 100)));
      $newFirstUplineBalance = $firstUpline->live_balance + $commission;

      $firstUpline->live_balance = $newFirstUplineBalance;
      $firstUpline->save();

      Referral::create([
        "user_id" => $firstUpline->id,
        "referral_code" => $referralCode,
        "amount" => $commission,
        "level" => "2",
      ]);

      $firstUpline->notify(
        new CommissionEarned(
          $firstUpline->name,
          $depositOwnerName,
          strval($commission / 100),
          "deposit",
        ),
      );

      Log::info("Ran level 1 & 2 referral payout for user IDs: " . $firstUpline->id . ", " . $secondUpline->id);
    }

    if ($this->level === 3) {
      // Lock all upline users to prevent race conditions
      $thirdUpline = User::where("id", "=", $this->thirdUpline["id"], "and")
        ->lockForUpdate()
        ->first();

      if (!$thirdUpline) {
        throw new \Exception("Third upline user not found");
      }

      $secondUpline = User::where("id", "=", $this->secondUpline["id"], "and")
        ->lockForUpdate()
        ->first();

      if (!$secondUpline) {
        throw new \Exception("Second upline user not found");
      }

      $firstUpline = User::where("id", "=", $this->firstUpline["id"], "and")
        ->lockForUpdate()
        ->first();

      if (!$firstUpline) {
        throw new \Exception("First upline user not found");
      }

      /**
       * Top upline commission
       */
      $commission = intval(round($depositAmount * (2 / 100)));
      $newFirstUplineBalance = $firstUpline->live_balance + $commission;

      $firstUpline->live_balance = $newFirstUplineBalance;
      $firstUpline->save();

      Referral::create([
        "user_id" => $firstUpline->id,
        "referral_code" => $referralCode,
        "amount" => $commission,
        "level" => "3",
      ]);

      $firstUpline->notify(
        new CommissionEarned(
          $firstUpline->name,
          $depositOwnerName,
          strval($commission / 100),
          "deposit",
        ),
      );

      /**
       * Middle upline commission
       */
      $commission = intval(round($depositAmount * (4 / 100)));
      $newSecondUplineBalance = $secondUpline->live_balance + $commission;

      $secondUpline->live_balance = $newSecondUplineBalance;
      $secondUpline->save();

      Referral::create([
        "user_id" => $secondUpline->id,
        "referral_code" => $referralCode,
        "amount" => $commission,
        "level" => "2",
      ]);

      $secondUpline->notify(
        new CommissionEarned(
          $secondUpline->name,
          $depositOwnerName,
          strval($commission / 100),
          "deposit",
        ),
      );

      /**
       * Last upline commission
       */
      $commission = intval(round($depositAmount * (8 / 100)));
      $newThirdUplineBalance = $thirdUpline->live_balance + $commission;

      $thirdUpline->live_balance = $newThirdUplineBalance;
      $thirdUpline->save();

      Referral::create([
        "user_id" => $thirdUpline->id,
        "referral_code" => $referralCode,
        "amount" => $commission,
        "level" => "1",
      ]);

      $thirdUpline->notify(
        new CommissionEarned(
          $thirdUpline->name,
          $depositOwnerName,
          strval($commission / 100),
          "deposit",
        ),
      );

      Log::info("Ran level 1, 2 & 3 referral payout for user IDs: " . $firstUpline->id . ", " . $secondUpline->id . ", " . $thirdUpline->id);
    }
  }

  public function approveDeposit(int $depositIntentId, string $paymentMethod, int $userId, int $amount)
  {
    try {
      DB::transaction(function () use ($depositIntentId, $paymentMethod, $userId, $amount) {
        // Lock the deposit record first to prevent concurrent approvals
        Deposit::create([
          "user_id" => $userId,
          "payment_method" => $paymentMethod,
          "amount" => $amount,
          "payment_screenshot_path" => "",
          "status" => "confirmed",
        ]);

        $depositIntent = DepositIntent::where("id", "=", $depositIntentId, "and")
          ->lockForUpdate()
          ->first();

        if (!$depositIntent) {
          throw new \Exception("Deposit intent not found");
        }

        $allowReferral = $this->allowReferral[$depositIntentId] ?? true;

        $depositIntent->status = 'confirmed';
        $depositIntent->allow_referral = $allowReferral;
        $depositIntent->save();

        // Lock the user record for balance update
        $user = User::where("id", "=", $userId, "and")
          ->lockForUpdate()
          ->first();

        if (!$user) {
          throw new \Exception("User not found");
        }

        $userLiveBalance = $user->live_balance;
        $newBalance = $userLiveBalance + $amount;

        // Update user balance
        $user->live_balance = $newBalance;
        $user->save();

        // Send notification (inside transaction to ensure it only happens once)
        $user->notify(
          new DepositApproved($user->name, strval($amount / 100)),
        );

        // Process referral payouts if applicable
        if ($user->referred_by !== null && $allowReferral) {
          Log::info("Processing referral payouts for user ID: " . $user->id);
          $this->computeUpline($user->referred_by);
          Log::info("Current Level: " . $this->level);
          $this->processReferralPayouts(
            $amount,
            $user->referral_code,
            $user->name,
          );
        }
      });

      session()->flash(
        "success-message",
        "Deposit confirmed successfully",
      );
    } catch (\Exception $e) {
      session()->flash("error-message", $e->getMessage());
    }
  }

  public function render()
  {
    $depositIntents = DepositIntent::with('user')->whereHas('user', function ($query) {
      $query->where('is_admin', 0);
    })->latest()->paginate(10);

    foreach ($depositIntents as $intent) {
      if (!array_key_exists($intent->id, $this->allowReferral)) {
        $this->allowReferral[$intent->id] = (bool) $intent->allow_referral;
      }
    }

    return view('livewire.admin.admin-deposit-intent', [
      'depositIntents' => $depositIntents
    ]);
  }
}
